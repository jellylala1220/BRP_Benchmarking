# ğŸš€ å¿«é€Ÿå¼€å§‹ - ä¸€æ­¥ä¸€æ­¥è¿è¡ŒæŒ‡å—

## ğŸ“‹ ç¬¬ä¸€æ­¥ï¼šå®‰è£…ä¾èµ–

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /Users/lvlei/PycharmProjects/BPR/bpr_benchmark

# å®‰è£…æ‰€æœ‰ä¾èµ–
pip install pandas numpy scipy scikit-learn openpyxl pyyaml
```

æˆ–è€…ä½¿ç”¨requirements.txtï¼š
```bash
pip install -r requirements.txt
```

---

## ğŸ¯ ç¬¬äºŒæ­¥ï¼šé€‰æ‹©è¿è¡Œæ–¹å¼

### æ–¹å¼Aï¼šå¿«é€Ÿæµ‹è¯•ï¼ˆæ¨èç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼‰

**æœ€ç®€å•çš„æ–¹å¼ï¼Œæµ‹è¯•å•ä¸ªæ¨¡å‹**

```bash
cd /Users/lvlei/PycharmProjects/BPR/bpr_benchmark
python test_single_model.py
```

**è¿™ä¸ªè„šæœ¬ä¼š**ï¼š
1. âœ… è‡ªåŠ¨æ„å»ºFinalData
2. âœ… åˆ†å‰²è®­ç»ƒ/æµ‹è¯•é›†
3. âœ… è®­ç»ƒM0_BPRæ¨¡å‹ï¼ˆä½¿ç”¨NLSæ–¹æ³•ï¼‰
4. âœ… é¢„æµ‹å’Œè¯„ä¼°
5. âœ… æ˜¾ç¤ºç»“æœ

**é¢„æœŸè¾“å‡º**ï¼š
```
============================================================
BPRæ¡†æ¶ - å¿«é€Ÿæµ‹è¯•
============================================================

[æ­¥éª¤1] æ„å»ºFinalData
------------------------------------------------------------
æ„å»ºFinalData: LinkID=115030402
...
âœ“ FinalDataæ„å»ºæˆåŠŸï¼
  æ•°æ®å½¢çŠ¶: (2880, 23)
  æ—¶é—´èŒƒå›´: 2024-09-01 00:00:00 è‡³ 2024-09-30 23:45:00

[æ­¥éª¤2] åˆ†å‰²è®­ç»ƒ/æµ‹è¯•é›†
------------------------------------------------------------
  è®­ç»ƒé›†: 1920 æ¡ (è‡³ 2024-09-20)
  æµ‹è¯•é›†: 960 æ¡ (ä» 2024-09-20 ä¹‹å)

[æ­¥éª¤3] è®­ç»ƒM0_BPRæ¨¡å‹
------------------------------------------------------------
M0_BPR è®­ç»ƒ
  æ–¹æ³•: nls
...
âœ“ æ¨¡å‹è®­ç»ƒå®Œæˆ

[æ­¥éª¤4] é¢„æµ‹
------------------------------------------------------------
  é¢„æµ‹äº† 960 æ¡è®°å½•

[æ­¥éª¤5] è¯„ä¼°ç»“æœ
------------------------------------------------------------
è¯„ä¼°æŒ‡æ ‡
============================================================
  MAE:  8.45 ç§’
  RMSE: 12.34 ç§’
  MAPE: 7.89 %
  RÂ²:   0.9234
============================================================

âœ“ æµ‹è¯•å®Œæˆï¼
```

---

### æ–¹å¼Bï¼šä½¿ç”¨CLIå·¥å…·æ„å»ºæ•°æ®

**å…ˆæ„å»ºFinalDataï¼Œå†è¿è¡Œæ¨¡å‹**

```bash
cd /Users/lvlei/PycharmProjects/BPR/bpr_benchmark

# æ„å»ºFinalData
python -m pipelines.build_finaldata \
    --link 115030402 \
    --preclean "../Data/Precleaned_M67_Traffic_Data_September_2024.xlsx" \
    --snapshot "../Data/M67 westbound between J4 and J3 mainCarriageway 115030402.csv" \
    --capacity 6649 \
    --length 2713.8037 \
    --start 2024-09-01 \
    --end 2024-09-30 \
    --output outputs/finaldata/
```

**ç„¶åè¿è¡Œæ¨¡å‹**ï¼š
```python
# åˆ›å»º run_model.py
import sys
from pathlib import Path
import pandas as pd

sys.path.append(str(Path(__file__).parent))

from utils.data import build_finaldata
from models.m0_bpr_new import M0_BPR
from utils.metrics import calculate_all_metrics

# åŠ è½½FinalData
df = pd.read_parquet("outputs/finaldata/finaldata_115030402.parquet")

# åˆ†å‰²æ•°æ®
train_end = "2024-09-20"
df_train = df[df['datetime'] <= train_end]
df_test = df[df['datetime'] > train_end]

# è®­ç»ƒå’Œé¢„æµ‹
model = M0_BPR()
model.fit(df_train, method='nls')
y_pred = model.predict(df_test)
y_true = df_test['fused_tt_15min'].values

# è¯„ä¼°
metrics = calculate_all_metrics(y_true, y_pred)
print(f"MAE: {metrics['MAE']:.2f} ç§’")
```

---

### æ–¹å¼Cï¼šè¿è¡Œå®Œæ•´åŸºå‡†æµ‹è¯•

**æµ‹è¯•æ‰€æœ‰æ¨¡å‹å’Œæ–¹æ³•ç»„åˆ**

```bash
cd /Users/lvlei/PycharmProjects/BPR/bpr_benchmark
python run_benchmark.py
```

**æ³¨æ„**ï¼šéœ€è¦å…ˆæ›´æ–° `configs/default.yaml` ä¸­çš„è·¯å¾„

---

## ğŸ”§ ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥ç»“æœ

### æŸ¥çœ‹è¾“å‡ºæ–‡ä»¶

```bash
# æŸ¥çœ‹FinalData
ls -lh outputs/finaldata/

# æŸ¥çœ‹åŸºå‡†æµ‹è¯•ç»“æœ
ls -lh outputs/
```

### æŸ¥çœ‹QCæŠ¥å‘Š

```bash
# æŸ¥çœ‹æ•°æ®è´¨é‡æŠ¥å‘Š
cat outputs/finaldata/qc_report_115030402.csv
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### é—®é¢˜1ï¼šæ‰¾ä¸åˆ°æ•°æ®æ–‡ä»¶

**é”™è¯¯**ï¼š`FileNotFoundError`

**è§£å†³**ï¼šæ£€æŸ¥æ–‡ä»¶è·¯å¾„ï¼Œä½¿ç”¨ç»å¯¹è·¯å¾„ï¼š

```python
df = build_finaldata(
    link_id=115030402,
    precleaned_path="/Users/lvlei/PycharmProjects/BPR/Data/Precleaned_M67_Traffic_Data_September_2024.xlsx",
    snapshot_csv_path="/Users/lvlei/PycharmProjects/BPR/Data/M67 westbound between J4 and J3 mainCarriageway 115030402.csv",
    ...
)
```

### é—®é¢˜2ï¼šç¼ºå°‘ä¾èµ–

**é”™è¯¯**ï¼š`ModuleNotFoundError: No module named 'xxx'`

**è§£å†³**ï¼š
```bash
pip install pandas numpy scipy scikit-learn openpyxl pyyaml
```

### é—®é¢˜3ï¼šCSVåŒ¹é…å¤±è´¥

**è­¦å‘Š**ï¼š`åŒ¹é…ç‡è¾ƒä½`

**è§£å†³**ï¼šè¿™æ˜¯æ­£å¸¸çš„ï¼Œä»£ç ä¼šè‡ªåŠ¨å›é€€åˆ°è®¡ç®—å€¼

---

## ğŸ“ æ¨èæµç¨‹

### ç¬¬ä¸€æ¬¡è¿è¡Œï¼ˆéªŒè¯ç¯å¢ƒï¼‰

```bash
# 1. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 2. è¿è¡Œå¿«é€Ÿæµ‹è¯•
cd bpr_benchmark
python test_single_model.py
```

### ç¬¬äºŒæ¬¡è¿è¡Œï¼ˆæµ‹è¯•ä¸åŒæ–¹æ³•ï¼‰

ä¿®æ”¹ `test_single_model.py`ï¼Œæµ‹è¯•ä¸åŒæ–¹æ³•ï¼š

```python
# æµ‹è¯•classicalæ–¹æ³•
model.fit(df_train, method='classical')

# æµ‹è¯•loglinearæ–¹æ³•
model.fit(df_train, method='loglinear')
```

### ç¬¬ä¸‰æ¬¡è¿è¡Œï¼ˆå®Œæ•´åŸºå‡†æµ‹è¯•ï¼‰

```bash
python run_benchmark.py
```

---

## âœ… æˆåŠŸæ ‡å¿—

å¦‚æœçœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼Œè¯´æ˜è¿è¡ŒæˆåŠŸï¼š

```
âœ“ FinalDataæ„å»ºæˆåŠŸï¼
âœ“ æ¨¡å‹è®­ç»ƒå®Œæˆ
âœ“ é¢„æµ‹å®Œæˆ
âœ“ è¯„ä¼°å®Œæˆ

è¯„ä¼°æŒ‡æ ‡:
  MAE:  X.XX ç§’
  RMSE: X.XX ç§’
  MAPE: X.XX %
  RÂ²:   X.XXXX
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

è¿è¡ŒæˆåŠŸåï¼Œæ‚¨å¯ä»¥ï¼š
1. æŸ¥çœ‹ `outputs/` ç›®å½•ä¸­çš„ç»“æœ
2. å°è¯•ä¸åŒçš„æ¨¡å‹ï¼ˆM1, M2, M3ç­‰ï¼‰
3. å°è¯•ä¸åŒçš„ä¼°è®¡æ–¹æ³•
4. è¿è¡Œå®Œæ•´åŸºå‡†æµ‹è¯•

---

**ç¥æ‚¨è¿è¡Œé¡ºåˆ©ï¼** ğŸš€

